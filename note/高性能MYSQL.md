[TOC]

# mysql基础

## mysql的基础架构

![WechatIMG1](/Users/spiko/Documents/notes/img/WechatIMG1.jpeg)

- 第一层**连接处理，授权认证，安全等**。

- 第二层是mysql的核心服务层，包括**查询解析，分析，优化，缓存**，以及**所有的内置函数，存储过程，触发器，视图等。**

- 第三层是存储引擎，服务器通过API（屏蔽了不同存储引擎之间的差异）和存储引擎进行通讯，存储引擎的API包含了几十个**底层函数**，比如执行**"开始一个事物"**，**"通过主键提取一条记录"**等。但它不会去解析**SQL**。

  > innodb不同，它会去解析外键的定义，因为mysql服务器本身没有实现这个功能。

## 连接与安全

每个客户端都会和服务器维持一个线程，服务器会负责缓存线程。

> 在5.6以前，mysql会对每个连接创建一个线程,请求结束后销毁线程。在高并发的情况下，为了避免频繁创建和释放连接，可以通过thread-cache将线程缓存起来，请求来了先尝试从cache中获取，重复利用线程资源。
>
> **show variables like 'thread_cache_size';**
>
> 在低并发的情况下，thread_cache可以成为一个有效的优化机制，但在并发突然增加时，会产生非常严重的问题。比如thead_cache_size是512，突然来了3000个连接怎么办？
> mysql在5.6之前，会硬着头皮创建3000个线程.
>
> 此时唯一的做法就是控制连接数在512以下。通过客户端使用连接池技术，是可以控制总的连接个数，超过连接池最大值，客户端直接拒绝响应。但是多个应用连一个库，再诸如一个mysql实例多库的情况，更上雪上加霜。

**mysql5.6之后支持线程池插件。**

1. 客户端连接时，服务器会验证用户名密码等信息。
2. 连接成功后，会继续验证权限信息。

## 优化与执行

mysql会解析查询，并**创建内部数据结构（解析树）**，然后对其进行优化（**重写查询，表的读取顺序，选择合适的索引等）。**

